= How to define backends

This page explains how to author a backend that integrates with nixos-artifacts.
A backend implements serialization and deserialization of artifact files. Backends can be packaged as separate flakes and plugged into a project.

NOTE: Have a look at xref:generate-artifacts-cli.adoc[artifacts cli] on how to use the defined backends.

WARNING: The backend interface is experimental and may change.

== Environment variables and directories

Backend scripts and generator scripts operate in temporary directories.
Everything the script should use is handed over via files, directories and environment variables.

== Backend phases / scripts

If a script returns a non-zero exit code, the process is aborted.

=== check_configuration

Verifies the validity of `$config` rendered from `artifacts.config.<backend-name>`.

.Variables at runtime:
- `$config`: a JSON file containing `artifacts.config.<backend-name>` as JSON.
- `$machine`: the machine name as a string.
- `$artifact`: the artifact name being processed.

=== check_serialization

Called during `generate` to check whether the requested artifact already exists, in order to avoid overwriting existing artifacts.

.Variables at runtime:
- `$inputs`: directory containing all files that should exist. Each file is a JSON object containing the information defined in your nixosConfiguration (`artifacts.store.<artifact>.file`).
- `$config`: a JSON file containing `artifacts.config.<backend-name>`.
- `$machine`: the machine name as a string.
- `$artifact`: the artifact name being processed.

=== serialize

Called when a generator script successfully creates files.

.Variables at runtime:
- `$out`: directory containing all files generated by the generator script.
- `$config`: a JSON file containing `artifacts.config.<backend-name>`.
- `$machine`: the machine name as a string.
- `$artifact`: the artifact name being processed.

=== deserialize

Restores previously serialized artifact files for use on the target system.

.Variables at runtime:
- `$inputs`: directory containing the expected files metadata (same format as in check_serialization).
- `$config`: a JSON file containing `artifacts.config.<backend-name>`.
- `$machine`: the machine name as a string.
- `$artifact`: the artifact name being processed.
