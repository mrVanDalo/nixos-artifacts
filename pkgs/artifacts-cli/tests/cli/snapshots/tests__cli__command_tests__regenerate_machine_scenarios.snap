---
source: tests/cli/command_tests.rs
info:
  program: artifacts
  args:
    - "--log-level=trace"
    - regenerate
    - /home/palo/dev/artifacts/nixos-artifacts/pkgs/artifacts-cli/examples/bigger_setup
    - "--machine=machine-one"
  env:
    NIXOS_ARTIFACTS_BACKEND_CONFIG: /home/palo/dev/artifacts/nixos-artifacts/pkgs/artifacts-cli/examples/bigger_setup/backend.toml
    TMPDIR: /tmp/artifacts-cli
  stdin: ""
---
success: true
exit_code: 0
----- stdout -----
ğŸ› Running nix build on /home/palo/dev/artifacts/nixos-artifacts/pkgs/artifacts-cli/examples/bigger_setup
ğŸ’¬ /run/current-system/sw/bin/nix build --impure -I flake=/home/palo/dev/artifacts/nixos-artifacts/pkgs/artifacts-cli/examples/bigger_setup --no-link --print-out-paths --expr 'let
ğŸ’¬   system = "x86_64-linux";
ğŸ’¬   filterAttrs =
ğŸ’¬     pred: set:
ğŸ’¬     builtins.removeAttrs set (builtins.filter (name: !pred name set.${name}) (builtins.attrNames set));
ğŸ’¬   flake = builtins.getFlake (toString <flake>);
ğŸ’¬   pkgs = flake.inputs.nixpkgs.legacyPackages.${system};
ğŸ’¬   nixosConfigurations = builtins.attrNames (
ğŸ’¬     filterAttrs (
ğŸ’¬       machine: configuration: builtins.hasAttr "artifacts" configuration.options
ğŸ’¬     ) flake.nixosConfigurations
ğŸ’¬   );
ğŸ’¬   homeConfigurations =
ğŸ’¬     let
ğŸ’¬       hc = if builtins.hasAttr "homeConfigurations" flake then flake.homeConfigurations else { };
ğŸ’¬     in
ğŸ’¬     builtins.attrNames (
ğŸ’¬       filterAttrs (user: configuration: builtins.hasAttr "artifacts" configuration.options) hc
ğŸ’¬     );
ğŸ’¬   nixos = map (name: {
ğŸ’¬     machine = name;
ğŸ’¬     artifacts = flake.nixosConfigurations.${name}.config.artifacts.store;
ğŸ’¬     config =
ğŸ’¬       if (builtins.hasAttr "config" flake.nixosConfigurations.${name}.config.artifacts) then
ğŸ’¬         flake.nixosConfigurations.${name}.config.artifacts.config
ğŸ’¬       else
ğŸ’¬         { };
ğŸ’¬   }) nixosConfigurations;
ğŸ’¬   home = map (name: {
ğŸ’¬     user = name;
ğŸ’¬     artifacts = flake.homeConfigurations.${name}.config.artifacts.store;
ğŸ’¬     config =
ğŸ’¬       if (builtins.hasAttr "config" flake.homeConfigurations.${name}.config.artifacts) then
ğŸ’¬         flake.homeConfigurations.${name}.config.artifacts.config
ğŸ’¬       else
ğŸ’¬         { };
ğŸ’¬   }) homeConfigurations;
ğŸ’¬   make = { inherit nixos home; };
ğŸ’¬ in
ğŸ’¬ pkgs.writeText "test.json" (builtins.toJSON make)
ğŸ’¬ '
ğŸ’¬ make config (pretty):
ğŸ’¬ {
ğŸ’¬   "home": [],
ğŸ’¬   "nixos": [
ğŸ’¬     {
ğŸ’¬       "artifacts": {
ğŸ’¬         "artifact-one": {
ğŸ’¬           "files": {
ğŸ’¬             "first-secret": {
ğŸ’¬               "group": "root",
ğŸ’¬               "mode": "0400",
ğŸ’¬               "name": "first-secret",
ğŸ’¬               "owner": "root",
ğŸ’¬               "path": "/run/secrets/first-secret"
ğŸ’¬             }
ğŸ’¬           },
ğŸ’¬           "generator": "/nix/store/[hash]-test_generator_one.sh",
ğŸ’¬           "name": "artifact-one",
ğŸ’¬           "prompts": {},
ğŸ’¬           "serialization": "test",
ğŸ’¬           "shared": false
ğŸ’¬         },
ğŸ’¬         "artifact-two": {
ğŸ’¬           "files": {
ğŸ’¬             "second-secret": {
ğŸ’¬               "group": "root",
ğŸ’¬               "mode": "0400",
ğŸ’¬               "name": "second-secret",
ğŸ’¬               "owner": "root",
ğŸ’¬               "path": "/run/secrets/second-secret"
ğŸ’¬             }
ğŸ’¬           },
ğŸ’¬           "generator": "/nix/store/[hash]-test_generator_two.sh",
ğŸ’¬           "name": "artifact-two",
ğŸ’¬           "prompts": {},
ğŸ’¬           "serialization": "test",
ğŸ’¬           "shared": false
ğŸ’¬         }
ğŸ’¬       },
ğŸ’¬       "config": {},
ğŸ’¬       "machine": "machine-one"
ğŸ’¬     },
ğŸ’¬     {
ğŸ’¬       "artifacts": {
ğŸ’¬         "artifact-one": {
ğŸ’¬           "files": {
ğŸ’¬             "first-secret": {
ğŸ’¬               "group": "root",
ğŸ’¬               "mode": "0400",
ğŸ’¬               "name": "first-secret",
ğŸ’¬               "owner": "root",
ğŸ’¬               "path": "/run/secrets/first-secret"
ğŸ’¬             }
ğŸ’¬           },
ğŸ’¬           "generator": "/nix/store/[hash]-test_generator_one.sh",
ğŸ’¬           "name": "artifact-one",
ğŸ’¬           "prompts": {},
ğŸ’¬           "serialization": "test",
ğŸ’¬           "shared": false
ğŸ’¬         },
ğŸ’¬         "artifact-two": {
ğŸ’¬           "files": {
ğŸ’¬             "second-secret": {
ğŸ’¬               "group": "root",
ğŸ’¬               "mode": "0400",
ğŸ’¬               "name": "second-secret",
ğŸ’¬               "owner": "root",
ğŸ’¬               "path": "/run/secrets/second-secret"
ğŸ’¬             }
ğŸ’¬           },
ğŸ’¬           "generator": "/nix/store/[hash]-test_generator_two.sh",
ğŸ’¬           "name": "artifact-two",
ğŸ’¬           "prompts": {},
ğŸ’¬           "serialization": "test",
ğŸ’¬           "shared": false
ğŸ’¬         }
ğŸ’¬       },
ğŸ’¬       "config": {},
ğŸ’¬       "machine": "machine-two"
ğŸ’¬     }
ğŸ’¬   ]
ğŸ’¬ }
[regenerate]
ğŸ› {
ğŸ›   "files": [
ğŸ›     {
ğŸ›       "group": "root",
ğŸ›       "name": "first-secret",
ğŸ›       "owner": "root",
ğŸ›       "path": "/run/secrets/first-secret"
ğŸ›     }
ğŸ›   ],
ğŸ›   "files_to_produce": 1
ğŸ› }
âš¡ machine-one/artifact-one
ğŸ› run bwrap with command /nix/store/[hash]-test_generator_one.sh/bin/test_generator_one.sh
ğŸ’¬ bwrap \
ğŸ’¬ --unshare-all \
ğŸ’¬ --unshare-user \
ğŸ’¬ --uid 1000 \
ğŸ’¬ --gid 1000 \
ğŸ’¬ --tmpfs / \
ğŸ’¬ --chdir / \
ğŸ’¬ --ro-bind /nix/store /nix/store \
ğŸ’¬ --tmpfs /usr/lib/systemd \
ğŸ’¬ --proc /proc \
ğŸ’¬ --dev /dev \
ğŸ’¬ --bind /tmp/artifacts-cli/prompt-artifact-one /tmp/artifacts-cli/prompt-artifact-one \
ğŸ’¬ --bind /tmp/artifacts-cli/out-artifact-one /tmp/artifacts-cli/out-artifact-one \
ğŸ’¬ --ro-bind /nix/store/[hash]-test_generator_one.sh/bin /nix/store/[hash]-test_generator_one.sh/bin \
ğŸ’¬ --ro-bind /bin /bin \
ğŸ’¬ --ro-bind /usr/bin /usr/bin \
ğŸ’¬ --ro-bind /tmp/artifacts-cli/artifacts-cli-passwd-3029b01ac1f84b21.txt /etc/passwd \
ğŸ’¬ -- /bin/sh /nix/store/[hash]-test_generator_one.sh/bin/test_generator_one.sh
ğŸ’¾ serialize secrets
Environment variables:
out=/tmp/artifacts-cli/out-artifact-one
config=/tmp/artifacts-cli/config/config.json
machine=machine-one
artifact=artifact-one
username=
artifact_context=nixos
--- Begin /tmp/artifacts-cli/config/config.json ---
{}
--- End /tmp/artifacts-cli/config/config.json ---

=== Content of /tmp/artifacts-cli/out-artifact-one/first-secret ===
one
=========================
[regenerate]
ğŸ› {
ğŸ›   "files": [
ğŸ›     {
ğŸ›       "group": "root",
ğŸ›       "name": "second-secret",
ğŸ›       "owner": "root",
ğŸ›       "path": "/run/secrets/second-secret"
ğŸ›     }
ğŸ›   ],
ğŸ›   "files_to_produce": 1
ğŸ› }
âš¡ machine-one/artifact-two
ğŸ› run bwrap with command /nix/store/[hash]-test_generator_two.sh/bin/test_generator_two.sh
ğŸ’¬ bwrap \
ğŸ’¬ --unshare-all \
ğŸ’¬ --unshare-user \
ğŸ’¬ --uid 1000 \
ğŸ’¬ --gid 1000 \
ğŸ’¬ --tmpfs / \
ğŸ’¬ --chdir / \
ğŸ’¬ --ro-bind /nix/store /nix/store \
ğŸ’¬ --tmpfs /usr/lib/systemd \
ğŸ’¬ --proc /proc \
ğŸ’¬ --dev /dev \
ğŸ’¬ --bind /tmp/artifacts-cli/prompt-artifact-two /tmp/artifacts-cli/prompt-artifact-two \
ğŸ’¬ --bind /tmp/artifacts-cli/out-artifact-two /tmp/artifacts-cli/out-artifact-two \
ğŸ’¬ --ro-bind /nix/store/[hash]-test_generator_two.sh/bin /nix/store/[hash]-test_generator_two.sh/bin \
ğŸ’¬ --ro-bind /bin /bin \
ğŸ’¬ --ro-bind /usr/bin /usr/bin \
ğŸ’¬ --ro-bind /tmp/artifacts-cli/artifacts-cli-passwd-8e43491af6eee0ab.txt /etc/passwd \
ğŸ’¬ -- /bin/sh /nix/store/[hash]-test_generator_two.sh/bin/test_generator_two.sh
ğŸ’¾ serialize secrets
Environment variables:
out=/tmp/artifacts-cli/out-artifact-two
config=/tmp/artifacts-cli/config/config.json
machine=machine-one
artifact=artifact-two
username=
artifact_context=nixos
--- Begin /tmp/artifacts-cli/config/config.json ---
{}
--- End /tmp/artifacts-cli/config/config.json ---

=== Content of /tmp/artifacts-cli/out-artifact-two/second-secret ===
two
=========================
âœ… machine-two/artifact-one
âœ… machine-two/artifact-two

----- stderr -----
